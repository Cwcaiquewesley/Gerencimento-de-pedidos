<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Produto</title>
    <link rel="stylesheet" href="/public/css/main.css">
    <link rel="stylesheet" href="/public/css/produto.css">
</head>
<body>
    <div class="container fade-in">
        <header>
            <h1>Gerenciamento de Pedidos</h1>
            <nav>
                <ul>
                    <li><a href="/">Início</a></li>
                    <li><a href="/pedidos">Pedidos</a></li>
                    <li><a href="/produtos" class="active">Produtos</a></li>
                    <li><a href="/clientes">Clientes</a></li>
                    <li><a href="/itens">Itens</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <section class="produtos-section">
                <div class="section-header">
                    <h2>Editar Produto #<%= produto.id %></h2>
                </div>

                <form class="form-produto" id="formProduto">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeProduto">Nome do Produto:</label>
                            <input type="text" id="nomeProduto" name="nomeProduto" value="<%= produto.nomeProduto %>" required placeholder="Digite o nome do produto">
                        </div>

                        <div class="form-group">
                            <label for="tipo">Categoria/Tipo:</label>
                            <input type="text" id="tipo" name="tipo" value="<%= produto.tipo %>" required placeholder="Digite a categoria">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="valor">Preço (R$):</label>
                            <input type="number" id="valor" name="valor" value="<%= produto.valor %>" min="0" step="0.01" required placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label for="quantidade">Estoque:</label>
                            <input type="number" id="quantidade" name="quantidade" value="<%= produto.quantidade %>" min="0" required placeholder="0">
                        </div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label for="status">
                            <input type="checkbox" id="status" name="status" value="true" <% if (produto.status) { %>checked<% } %>>
                            Produto Ativo
                        </label>
                    </div>

                    <div class="info-historico">
                        <p><strong>ID do Produto:</strong> <%= produto.idProduto %></p>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        <button type="button" class="btn btn-danger btn-delete-product" data-product-id="<%= produto.idProduto %>">Deletar Produto</button>
                        <a href="/produtos" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </section>
        </main>

        <footer>
            <p>&copy; 2026 Sistema de Gerenciamento de Pedidos. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script src="/js/script.js"></script>
    <script>
        document.getElementById('formProduto').addEventListener('submit', async function(e) {
            e.preventDefault();

            const productId = '<%= produto.idProduto %>';
            const formData = new FormData(this);
            const dados = {
                nomeProduto: formData.get('nomeProduto'),
                tipo: formData.get('tipo'),
                valor: parseFloat(formData.get('valor')),
                quantidade: parseInt(formData.get('quantidade')),
                status: formData.get('status') === 'true'
            };

            try {
                const response = await fetch(`/api/produtos/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Produto atualizado com sucesso!');
                    window.location.href = '/produtos';
                } else {
                    alert('Erro ao atualizar produto: ' + (result.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro na comunicação com o servidor');
            }
        });

        // Máscara básica para o campo valor
        document.getElementById('valor').addEventListener('blur', function(e) {
            let value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                e.target.value = value.toFixed(2);
            }
        });

        // Evento para deletar produto
        document.querySelector('.btn-delete-product').addEventListener('click', function() {
            const productId = this.dataset.productId;
            if (confirm('Tem certeza que deseja deletar este produto? Esta ação não pode ser desfeita.')) {
                fetch(`/api/produtos/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Produto deletado com sucesso!');
                        location.href = '/produtos';
                    } else {
                        alert('Erro ao deletar produto');
                    }
                })
                .catch(error => console.error('Erro:', error));
            }
        });
    </script>
</body>
</html>
